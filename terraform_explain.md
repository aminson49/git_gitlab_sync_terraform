# Terraform Sync Explained (Simple)

This project uses Terraform to set up two-way syncing between a GitHub repo
and a GitLab repo. You fill in a few values (tokens, repo names, Jenkins URL),
then Terraform creates the needed webhooks, CI variables, and files.

## What the code does

1. **GitHub → GitLab (push to GitHub)**
   - Terraform creates a **GitHub webhook**.
   - That webhook calls **Jenkins** whenever you push to GitHub.
   - Jenkins runs the `sync_repos.py` script (generated by Terraform).
   - The script pushes the GitHub branch to GitLab.

2. **GitLab → GitHub (push to GitLab)**
   - Terraform sets **GitLab CI variables**.
   - Terraform writes a `.gitlab-ci.yml` file for the GitLab pipeline.
   - When you push to GitLab, the pipeline pushes changes to GitHub.

## Code map (where things live)

- `terraform/main.tf`  
  Wires the two modules (`github_to_gitlab_sync` and `gitlab_to_github_sync`).

- `terraform/providers.tf`  
  Provider configs for GitHub, GitLab, Jenkins, and AWS (state bootstrap).

- `terraform/variables.tf`  
  All input variables used by the project.

- `terraform/modules/github_to_gitlab/*`  
  Creates GitHub webhook, Jenkins job, credentials, and generated files.

- `terraform/modules/gitlab_to_github/*`  
  Creates GitLab CI variables and writes `.gitlab-ci.yml`.

- `terraform/state_backend.tf`  
  Creates S3 bucket + DynamoDB table (if enabled).

## Important Terraform resources (in plain terms)

- `github_repository_webhook`  
  Adds the webhook so GitHub tells Jenkins when a push happens.

- `gitlab_project_variable`  
  Stores GitHub token/repo info in GitLab CI.

- `jenkins_job`  
  Creates the Jenkins pipeline job.

- `local_file`  
  Writes `Jenkinsfile`, `.gitlab-ci.yml`, and `sync_repos.py`.

- `null_resource`  
  Used to create Jenkins credentials and optionally push files to GitHub.

## Files Terraform generates

- `Jenkinsfile` (in repo root)  
  Tells Jenkins how to run the sync script.

- `sync_repos.py` (in repo root)  
  The script that copies GitHub code to GitLab.

- `.gitlab-ci.yml` (in repo root)  
  The GitLab pipeline that copies GitLab code to GitHub.

## Inputs you set (terraform.tfvars)

These are the important values:

- `github_token` and `gitlab_token`  
  Access tokens so Terraform can create webhooks/variables.

- `github_to_gitlab` and `gitlab_to_github`  
  Repo names for both directions.

- `jenkins_webhook_url`  
  URL Jenkins uses to receive GitHub webhooks.

Optional Jenkins job creation:

- `jenkins_url`, `jenkins_username`, `jenkins_api_token`
- `jenkins_job_enabled`, `jenkins_job_name`, `jenkins_job_branch`
- `jenkins_scm_credentials_id`

## What Terraform creates on GitHub

- A webhook that sends push events to Jenkins.

## What Terraform creates on GitLab

- CI/CD variables for GitHub access.
- A `.gitlab-ci.yml` pipeline file.

## What Terraform creates on Jenkins (optional)

- A Jenkins job that pulls this repo and uses `Jenkinsfile`.

## How to run

1. Go into the `terraform` folder.
2. Run `terraform init`.
3. Run `terraform apply`.

## Important notes

- Do not commit `terraform.tfvars` (it contains secrets).
- If you set `jenkinsfile_enabled = true`, Terraform will recreate `Jenkinsfile`.
- If you set `sync_script_enabled = true`, Terraform will recreate `sync_repos.py`.
